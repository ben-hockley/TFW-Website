image: node:18

stages:
  - install
  - build
  - deploy

variables:
  NODE_ENV: "production"

# Install dependencies once and cache node_modules
install:
  stage: install
  tags: [comsc-ci]
  script:
    - cd tfw-seat-app
    - npm ci
  artifacts:
    paths:
      - tfw-seat-app/node_modules
    expire_in: 1h

# Build the Next.js app and produce a static export
build:
  stage: build
  tags: [comsc-ci]
  script:
    - cd tfw-seat-app
    - npm run build
    - npx next export -o out
    - cd ..
    - mkdir -p public
    - cp -r tfw-seat-app/out/* public/ || true
  artifacts:
    paths:
      - public
    expire_in: 1 week

# GitLab Pages job: uploads the prepared public/ directory
pages:
  stage: deploy
  tags: [comsc-ci]
  dependencies:
    - build
  script:
    - echo "Deploying to GitLab Pages"
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
# GitLab CI pipeline to build the Next.js app and deploy to GitHub Pages.
#
# This pipeline assumes your Next.js app is in the `tfw-seat-app` folder and
# is exportable using `next export` (fully static). If your app uses server
# side features (App Router with server-only routes) this static export will
# not work and you'll need a different hosting approach.
#
# Required CI/CD variables (set in GitLab project settings → CI / CD → Variables):
# - GITHUB_TOKEN: a Personal Access Token (repo scope) for the GitHub repo.
# - GITHUB_REPOSITORY: owner/repo (e.g. my-org/my-repo) of the GitHub repository
#   to which the gh-pages branch should be pushed.

image: node:20

stages:
  - build
  - deploy

variables:
  PROJECT_DIR: "tfw-seat-app"
  NEXT_EXPORT_DIR: "out"

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - ${PROJECT_DIR}/node_modules/

build:
  stage: build
  tags:
    - comsc-ci
  script:
    - cd ${PROJECT_DIR}
    - npm ci
    - npm run build
    # Export a static site (next export). Output will be placed at ../${NEXT_EXPORT_DIR}
    - npm run export -- -o ../${NEXT_EXPORT_DIR} || npx next export -o ../${NEXT_EXPORT_DIR}
  artifacts:
    paths:
      - ${NEXT_EXPORT_DIR}
    expire_in: 1 hour
  only:
    - main

deploy_to_github_pages:
  stage: deploy
  tags:
    - comsc-ci
  image: alpine:3.18
  dependencies:
    - build
  before_script:
    - apk add --no-cache git
  script:
    - echo "Deploying exported site to GitHub Pages"
    - if [ -d "${NEXT_EXPORT_DIR}" ]; then cd ${NEXT_EXPORT_DIR}; else echo "Export directory not found"; exit 1; fi
    - git init
    - git config user.name "GitLab CI"
    - git config user.email "ci@example.com"
    # Push to the gh-pages branch on GitHub. Requires GITHUB_TOKEN and GITHUB_REPOSITORY to be set.
    - git remote add gh "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git"
    - git checkout -b gh-pages
    - git add --all
    - git commit -m "GitLab CI: deploy ${CI_COMMIT_SHORT_SHA} to GitHub Pages" || echo "nothing to commit"
    - git push -f gh HEAD:gh-pages
  only:
    - main
